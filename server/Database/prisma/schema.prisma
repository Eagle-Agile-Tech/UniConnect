generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
}

// =========================
// ENUMS
// =========================
enum Role { 
  STUDENT 
  ADMIN 
  EXPERT 
  INSTITUTION 
  }
enum Visibility { 
  PUBLIC 
  GROUP 
  PRIVATE 
  }
enum ReactionType { 
  LIKE 
  LOVE 
  INSIGHTFUL 
  SUPPORT 
  CELEBRATE 
  }
enum GroupType { 
  PUBLIC 
  PRIVATE 
  }
enum GroupMemberRole { 
  MEMBER 
  ADMIN 
  }
enum MembershipStatus { 
  PENDING 
  APPROVED 
  REJECTED 
  LEFT 
  REMOVED 
  }
enum ChatType { 
  DIRECT 
  GROUP 
  }
enum ModerationStatus { 
  PENDING 
  APPROVED 
  REJECTED 
  }
enum NotificationType { 
  REACTION 
  COMMENT 
  FOLLOW 
  MESSAGE 
  SYSTEM
   }
enum NotificationReferenceType { 
  POST 
  COMMENT 
  USER 
  MESSAGE 
  COMMUNITY 
  }
enum MediaType { 
  IMAGE 
  VIDEO 
  DOCUMENT 
  }
  enum EducationLevel {
  UNDERGRADUATE
  POSTGRADUATE
  GRADUATED
}
enum NetworkStatus {
  CONNECTED
  PENDING
}
enum AuditAction {
  CREATE
  UPDATE
  DELETE
  SOFT_DELETE
  RESTORE
  APPROVE
  REJECT
  LOGIN
  LOGOUT
  ROLE_CHANGE
  STATUS_CHANGE
  SEND
  JOIN
  LEAVE
}

enum AuditStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELLED
}


// =========================
// CORE MODELS
// =========================
model User {
  id            String   @id @default(uuid())
  username      String   @unique
  email         String   @unique
  passwordHash  String
  role          Role     @default(STUDENT)
  isVerified    Boolean  @default(false)
  isDeleted     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  profile           UserProfile?
  posts             Post[]
  comments          PostComment[]
  messages          Message[]
  communities       CommunityMember[]
  expertProfile     ExpertProfile?
  notificationsReceived Notification[] @relation("NotificationRecipient")
  notificationsSent     Notification[] @relation("NotificationActor")
  postReactions         PostReaction[]
  commentReactions      CommentReaction[]
  messageReactions      MessageReaction[]
  chatParticipations ChatParticipant[]
  createdCommunities Community[]
  mediaUploads      Media[]
  favorites         Favorite[]
  networksA         Network[] @relation("UserNetworkA")
  networksB         Network[] @relation("UserNetworkB")
  originalPosts     Post[] @relation("PostRepostAuthor")
  auditlogs         AuditLog[]
  sessions Session[]


  @@index([email])
  @@index([username])
 
}

model UserProfile {
  id             String   @id @default(uuid())
  userId         String   @unique
  firstName      String
  lastName       String
  bio            String?
  profileImage   String?
  interests      String[] @default([])
  university     String?
  department     String?
  level          EducationLevel?
  yearOfStudy    Int?
  graduationYear Int?

  user           User @relation(fields: [userId], references: [id])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([userId])
}

model Institution {
  id          String @id @default(uuid())
  name        String
  description String?
  website     String?
  logoUri     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  affiliatedExperts ExpertProfile[]
}

model ExpertProfile {
  id                       String @id @default(uuid())
  expertId                 String @unique
  expertise                String
  bio                      String?
  profileImage             String?
  affiliatedInstitutionId  String?

  expert      User        @relation(fields: [expertId], references: [id])
  institution Institution? @relation(fields: [affiliatedInstitutionId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([affiliatedInstitutionId])
}

// =========================
// POSTS & COMMENTS
// =========================
model Post {
  id               String   @id @default(uuid())
  authorId         String
  content          String
  visibility       Visibility @default(PUBLIC)
  tags             String[]   @default([])
  category         String?
  embedding        Unsupported("vector(1536)")
  moderationStatus ModerationStatus @default(PENDING)
  isDeleted        Boolean @default(false)
  shareCount       Int    @default(0)
  originalPostId   String? // for shared comments, reference to original post
  originalAuthorId String? // for shared comments, reference to original author
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  author      User @relation(fields: [authorId], references: [id])
  comments    PostComment[]
  media       Media[] @relation("MediaPost") // structured relation
  favorites   Favorite[]
  reposts      Post[] @relation("PostRepost")
  originalPost   Post? @relation("PostRepost", fields: [originalPostId], references: [id])
  originalAuthor User? @relation("PostRepostAuthor", fields: [originalAuthorId], references: [id])
  postReactions PostReaction[]
  

  @@index([authorId])
  @@index([createdAt])
  @@index([visibility])
  @@index([moderationStatus])
  @@index([visibility, moderationStatus, createdAt])
  @@index([authorId, createdAt])
}

model PostComment {
  id              String @id @default(uuid())
  postId          String
  commenterId     String
  parentCommentId String?
  content         String
  moderationStatus ModerationStatus @default(PENDING)
  isDeleted        Boolean @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  post            Post @relation(fields: [postId], references: [id])
  commenter       User @relation(fields: [commenterId], references: [id])

  parentComment   PostComment? @relation("CommentReplies", fields: [parentCommentId], references: [id])
  replies         PostComment[] @relation("CommentReplies")
  commentReactions CommentReaction[]



  @@index([postId])
}

// =========================
// REACTIONS (polymorphic via reference)
// =========================
model PostReaction {
  id        String @id @default(uuid())
  type      ReactionType
  userId    String
  postId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  post Post @relation(fields: [postId], references: [id])

  @@unique([userId, postId])
  @@index([postId])
}

model CommentReaction {
  id        String @id @default(uuid())
  type      ReactionType
  userId    String
  commentId String
  createdAt DateTime @default(now())

  user    User @relation(fields: [userId], references: [id])
  comment PostComment @relation(fields: [commentId], references: [id])

  @@unique([userId, commentId])
  @@index([commentId])
}

model MessageReaction {
  id        String @id @default(uuid())
  type      ReactionType
  userId    String
  messageId String
  createdAt DateTime @default(now())

  user    User @relation(fields: [userId], references: [id])
  message Message @relation(fields: [messageId], references: [id])

  @@unique([userId, messageId])
  @@index([messageId])
}
model Favorite {
  id            String @id @default(uuid())
  userId        String
  postId        String
  createdAt     DateTime @default(now())

  user          User @relation(fields: [userId], references: [id])
  post          Post @relation(fields: [postId], references: [id])

  @@unique([userId, postId])
  @@index([postId])
}

// =========================
// COMMUNITIES & MEMBERS
// =========================
model Community {
  id          String @id @default(uuid())
  name        String
  description String?
  type        GroupType @default(PUBLIC)
  createdById String
  isDeleted   Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy   User @relation(fields: [createdById], references: [id])
  members     CommunityMember[]
  media       Media[] @relation("MediaCommunity") // structured relation
}

model CommunityMember {
  id          String @id @default(uuid())
  communityId String
  userId      String
  role        GroupMemberRole @default(MEMBER)
  status      MembershipStatus @default(PENDING)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  community   Community @relation(fields: [communityId], references: [id])
  user        User @relation(fields: [userId], references: [id])

  @@unique([communityId, userId])
  @@index([userId])
}

// =========================
// CHAT & MESSAGES
// =========================
model Chat {
  id      String @id @default(uuid())
  type    ChatType
  uniqueKey  String? @unique // for direct chats, a unique key combining user IDs to prevent duplicates
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  participants  ChatParticipant[]
  messages      Message[]
}

model ChatParticipant {
  id        String @id @default(uuid())
  chatId    String
  userId    String
  createdAt DateTime @default(now())

  lastReadAt DateTime?

  chat      Chat @relation(fields: [chatId], references: [id])
  user      User @relation(fields: [userId], references: [id])

  @@unique([chatId, userId])
}

model Message {
  id        String @id @default(uuid())
  chatId    String
  senderId  String
  content   String
  isDeleted Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chat      Chat @relation(fields: [chatId], references: [id])
  sender    User @relation(fields: [senderId], references: [id])
  messageReactions MessageReaction[]

  media     Media[] @relation("MediaMessage") // structured relation
  @@index([chatId])
}

// =========================
// NOTIFICATIONS 
// =========================
model Notification {
  id            String @id @default(uuid())
  recipientId   String
  actorId       String?
  type          NotificationType
  referenceId   String?
  referenceType NotificationReferenceType?
  isRead        Boolean @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  recipient     User @relation("NotificationRecipient", fields: [recipientId], references: [id])
  actor         User? @relation("NotificationActor", fields: [actorId], references: [id])

@@index([recipientId, isRead])
}

// =========================
// MEDIA 
// =========================
model Media {
  id           String @id @default(uuid())
  uploaderId   String
  postId       String?
  communityId  String?
  messageId    String?
 

  fileUrl      String
  fileType     MediaType
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  uploader     User @relation(fields: [uploaderId], references: [id])
  post         Post? @relation("MediaPost", fields: [postId], references: [id])
  community    Community? @relation("MediaCommunity", fields: [communityId], references: [id])
  message      Message? @relation("MediaMessage", fields: [messageId], references: [id])

  @@index([postId])
  @@index([communityId])
  @@index([messageId])
}

// =========================
// NETWORKING
// ========================
model Network {
  id          String @id @default(uuid())
  userAId   String
  userBId  String
  status NetworkStatus @default(PENDING)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userA    User @relation("UserNetworkA", fields: [userAId], references: [id])
  userB   User @relation("UserNetworkB", fields: [userBId], references: [id])

  @@unique([userAId, userBId])
  @@index([userBId , status])
  @@index([userAId, status])
 
}

// =========================
// LOG AND SESSION
// ========================

model Session {
  id            String    @id @default(uuid())
  userId        String
  token         String    @unique // JWT or session token (hashed in production)
  refreshToken  String?   @unique
  deviceInfo    Json?
  ipAddress     String?
  location      Json?
  userAgent     String?
  lastActiveAt  DateTime  @default(now()) // Last API call with this session
  expiresAt     DateTime
  createdAt     DateTime  @default(now())
  isRevoked     Boolean   @default(false)
  revokedAt     DateTime?

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([isRevoked])
  @@map("sessions")
}


model AuditLog {
  id           String       @id @default(uuid())
  userId       String?
  actionType   AuditAction
  entityType   String
  entityId     String?
  oldValue     Json?
  newValue     Json?
  changes      Json?
  metadata     Json?
  ipAddress    String?
  userAgent    String?
  status       AuditStatus  @default(SUCCESS)
  errorMessage String?
  createdAt    DateTime     @default(now())
  isArchived   Boolean      @default(false)
  archivedAt   DateTime?

  // Relations
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([actionType])
  @@index([createdAt])
  @@index([isArchived])
  @@map("audit_logs")
}

